<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Data Science Books</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 50px auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        input {
            flex: 1;
            padding: 15px 20px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            outline: none;
        }

        button {
            padding: 15px 40px;
            font-size: 18px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #f0f0f0;
        }

        #results {
            background: white;
            border-radius: 10px;
            padding: 30px;
            min-height: 200px;
        }

        .result {
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
        }

        .result:hover {
            border-color: #667eea;
        }

        .book-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .page-badge {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            float: right;
        }

        .loading {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        mark {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        .answer-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 16px;
        }

        .answer-box h2 {
            margin-bottom: 15px;
            font-size: 24px;
        }

        .answer-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .answer-content p {
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .answer-content strong {
            color: #ffeb3b;
            font-weight: 700;
        }

        .answer-content ul, .answer-content ol {
            margin: 15px 0 15px 20px;
            line-height: 1.8;
        }

        .answer-content li {
            margin-bottom: 8px;
        }

        .answer-content code {
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .key-takeaway {
            background: rgba(255, 235, 59, 0.2);
            border-left: 4px solid #ffeb3b;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-style: italic;
        }

        .visual-suggestion {
            background: rgba(103, 126, 234, 0.2);
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 14px;
        }

        .insufficient-info {
            background: rgba(255, 152, 0, 0.2);
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-style: italic;
        }

        .sources {
            margin-top: 30px;
        }

        .sources h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .source-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
        }

        .source-item .source-book {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .source-item .source-text {
            color: #555;
            font-style: italic;
        }

        .question-generator {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: transform 0.2s;
        }

        .generate-btn:hover {
            transform: scale(1.05);
        }

        .generated-questions {
            margin-top: 20px;
        }

        .question-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .question-card:hover {
            background: #e9ecef;
            border-left-width: 6px;
            transform: translateX(5px);
        }

        .question-number {
            color: #667eea;
            font-weight: bold;
            margin-right: 10px;
        }

        .question-text {
            color: #333;
            font-size: 15px;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin-left: 10px;
            font-weight: bold;
        }

        .difficulty-easy { background: #4caf50; color: white; }
        .difficulty-medium { background: #ff9800; color: white; }
        .difficulty-hard { background: #f44336; color: white; }

        .difficulty-selector {
            display: inline-block;
            margin: 10px;
        }

        .difficulty-selector select {
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            transition: all 0.3s;
        }

        .difficulty-selector select:hover {
            background: #f0f0f0;
        }

        .difficulty-selector label {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Search Data Science Books</h1>

        <div class="question-generator">
            <h3 style="margin-bottom: 15px; color: #333;">üí° Interview Question Generator</h3>
            <p style="color: #666; margin-bottom: 15px;">Generate random interview questions from your books</p>

            <div class="controls-row">
                <div class="difficulty-selector">
                    <label for="difficulty-select">Difficulty Level:</label>
                    <select id="difficulty-select">
                        <option value="random">üé≤ Random</option>
                        <option value="easy">‚úÖ Easy</option>
                        <option value="medium">‚ö° Medium</option>
                        <option value="hard">üî• Hard</option>
                    </select>
                </div>
                <button class="generate-btn" onclick="generateQuestions()">üé≤ Generate Questions</button>
            </div>

            <div id="generated-questions" class="generated-questions"></div>
        </div>

        <div class="search-box">
            <input id="query" type="text" placeholder="Ask anything, e.g., 'what is python', 'explain machine learning'" autofocus>
            <button onclick="search()">Search</button>
        </div>

        <div id="results">
            <div class="loading">
                <h3 style="margin-bottom: 15px;">üí° How to use AI-powered search:</h3>
                <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                    <p style="margin-bottom: 10px;"><strong>Ask natural questions:</strong> "What is machine learning?", "Explain gradient descent"</p>
                    <p style="margin-bottom: 10px;"><strong>Get structured answers:</strong> AI will organize information with key points, examples, and highlights</p>
                    <p style="margin-bottom: 10px;"><strong>Smart filtering:</strong> Irrelevant or inappropriate questions will be politely declined</p>
                    <p><strong>Visual suggestions:</strong> AI may suggest diagrams for complex topics</p>
                </div>
            </div>
        </div>
    </div>

    <!--
    SETUP INSTRUCTIONS:
    1. Get a free Groq API key from: https://console.groq.com/keys
    2. Replace 'YOUR_GROQ_API_KEY_HERE' on line 525 with your actual API key
    3. The interview question generator will then work!
    -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // PUT YOUR SUPABASE CREDENTIALS HERE
        const SUPABASE_URL = 'https://iteavenjozhzxupbxosu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWF2ZW5qb3poenh1cGJ4b3N1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjk4NTgsImV4cCI6MjA3ODYwNTg1OH0.AfBGdanvvHUoFOWYF94PN0ccLlWPVJFHN1At-kjzpkE';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Search on Enter key
        document.getElementById('query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });

        // Extract keywords from natural language query
        function extractKeywords(query) {
            // Remove common question words and stop words
            const stopWords = new Set([
                'what', 'is', 'are', 'the', 'a', 'an', 'how', 'why', 'when', 'where',
                'who', 'which', 'does', 'do', 'can', 'could', 'would', 'should',
                'tell', 'me', 'about', 'explain', 'describe', 'define', 'definition',
                'of', 'in', 'on', 'at', 'to', 'for', 'with', 'from', 'by'
            ]);

            // Split query into words and filter out stop words
            const words = query.toLowerCase()
                .replace(/[?.,!;:]/g, '') // Remove punctuation
                .split(/\s+/)
                .filter(word => word.length > 2 && !stopWords.has(word));

            return words;
        }

        // Calculate relevance score for a document
        function calculateRelevance(content, keywords) {
            const lowerContent = content.toLowerCase();
            let score = 0;

            keywords.forEach(keyword => {
                // Count occurrences of each keyword
                const regex = new RegExp(keyword, 'gi');
                const matches = lowerContent.match(regex);
                if (matches) {
                    score += matches.length * 10;

                    // Bonus for keyword appearing early in content
                    const firstIndex = lowerContent.indexOf(keyword);
                    if (firstIndex < 100) score += 20;
                    else if (firstIndex < 300) score += 10;
                }

                // Bonus for exact phrase match with surrounding words
                if (lowerContent.includes(keyword + ' is') ||
                    lowerContent.includes(keyword + ':') ||
                    lowerContent.includes('definition of ' + keyword)) {
                    score += 50;
                }
            });

            return score;
        }

        // Clean and extract meaningful sentences from content
        function extractMeaningfulSentences(content, keywords) {
            // Remove page markers, excessive whitespace, and artifacts
            let cleaned = content
                .replace(/={10,}/g, '') // Remove separator lines
                .replace(/PAGE \d+/gi, '')
                .replace(/\n{3,}/g, '\n\n')
                .replace(/\s{2,}/g, ' ')
                .trim();

            // Split into sentences
            const sentences = cleaned.split(/[.!?]+/).map(s => s.trim()).filter(s => s.length > 20);

            // Score each sentence based on keyword relevance
            const scoredSentences = sentences.map(sentence => {
                let score = 0;
                const lower = sentence.toLowerCase();

                keywords.forEach(keyword => {
                    if (lower.includes(keyword)) {
                        score += 10;
                        // Extra points for definition patterns
                        if (lower.includes(keyword + ' is') ||
                            lower.includes(keyword + ' are') ||
                            lower.includes(keyword + ':')) {
                            score += 20;
                        }
                    }
                });

                return { sentence, score };
            });

            // Filter and sort by relevance
            return scoredSentences
                .filter(s => s.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(s => s.sentence);
        }

        // Compose a coherent answer from multiple chunks using AI
        async function composeAnswer(results, keywords, query) {
            // Collect relevant content from top results
            const sources = [];
            let contextContent = '';

            results.slice(0, 8).forEach(item => {
                const sentences = extractMeaningfulSentences(item.content, keywords);
                if (sentences.length > 0) {
                    contextContent += `\n[From: ${item.book_name}]\n${sentences.slice(0, 5).join(' ')}\n`;

                    sources.push({
                        book: item.book_name,
                        chunk: item.page_number,
                        excerpt: sentences[0]
                    });
                }
            });

            console.log('Context content length:', contextContent.length); // Debug logging
            console.log('Number of sources:', sources.length); // Debug logging

            // Check if we have any context
            if (contextContent.trim().length === 0) {
                return {
                    answer: '<p>No relevant information found in the books for this question. Try rephrasing or using different keywords.</p>',
                    sources: []
                };
            }

            // Use AI to generate a comprehensive answer
            const aiAnswer = await generateAIAnswer(query, contextContent);

            return {
                answer: aiAnswer,
                sources: sources.slice(0, 5)
            };
        }

        // Generate AI-powered answer using Groq
        async function generateAIAnswer(question, bookContext) {
            // ‚ö†Ô∏è REPLACE THIS WITH YOUR API KEY FROM: https://console.groq.com/keys
            const GROQ_API_KEY = 'YOUR_GROQ_API_KEY_HERE';

            if (GROQ_API_KEY === 'YOUR_GROQ_API_KEY_HERE') {
                return `<p style="color: #ff9800;">‚ö†Ô∏è Please add your Groq API key to enable AI-powered answers.</p>
                        <p>Steps:</p>
                        <ol>
                            <li>Get a free API key from: <a href="https://console.groq.com/keys" target="_blank" style="color: #667eea;">console.groq.com/keys</a></li>
                            <li>Replace 'YOUR_GROQ_API_KEY_HERE' on line 453 with your actual key</li>
                            <li>Save and refresh the page</li>
                        </ol>`;
            }

            const prompt = `You are an expert Data Science instructor. A student has asked you a question, and you have access to relevant excerpts from Data Science textbooks.

IMPORTANT INSTRUCTIONS:
1. **Question Validation**: First, assess if the question is:
   - Relevant to data science, machine learning, statistics, or programming
   - Ethical and appropriate for educational purposes
   - If the question is irrelevant, unethical, or inappropriate, respond with: "I cannot answer this question as it is not relevant to data science education or may be inappropriate. Please ask a data science related question."

2. **Answer Structure** (if question is valid):
   - Start with a clear, direct answer to the question
   - Use **bold** for key terms and concepts
   - Organize information with bullet points or numbered lists when helpful
   - Provide practical examples where relevant
   - Keep it concise but comprehensive (2-4 paragraphs)

3. **Content Guidelines**:
   - Base your answer primarily on the book excerpts provided
   - If book content is insufficient or missing, you MAY supplement with well-known data science concepts, but add a note: "(Note: Supplemented with general data science knowledge)"
   - Highlight the most important takeaways with bullet points
   - For complex topics (algorithms, architectures, workflows), suggest: "üìä Visual aid: [brief description of what diagram would help]"
   - Provide concrete examples when possible

4. **Formatting**:
   - Use markdown formatting (**, bullet points, etc.)
   - Break complex concepts into digestible parts
   - End with a key takeaway if appropriate

STUDENT QUESTION: "${question}"

BOOK EXCERPTS:
${bookContext}

Please provide a well-structured, educational answer:`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{
                            role: 'system',
                            content: 'You are an expert Data Science instructor who provides clear, structured, and educational answers. You validate questions for relevance and ethics before answering.'
                        }, {
                            role: 'user',
                            content: prompt
                        }],
                        temperature: 0.7,
                        max_tokens: 1000,
                        top_p: 0.9
                    })
                });

                const result = await response.json();

                console.log('Groq API Response:', result); // Debug logging

                if (!response.ok) {
                    throw new Error(`API Error (${response.status}): ${result.error?.message || JSON.stringify(result)}`);
                }

                if (result.error) {
                    throw new Error(result.error.message);
                }

                if (!result.choices || !result.choices[0] || !result.choices[0].message) {
                    throw new Error('Invalid API response structure');
                }

                return formatAIAnswer(result.choices[0].message.content);

            } catch (error) {
                console.error('AI answer generation failed:', error);
                // Fallback to basic extraction if AI fails
                return `<p style="color: #ff6b6b;">‚ö†Ô∏è AI answer generation failed: ${error.message}</p>
                        <p>This could be due to:</p>
                        <ul>
                            <li>API key issues</li>
                            <li>Network connectivity</li>
                            <li>Rate limiting</li>
                        </ul>
                        <p>Check the browser console (F12) for more details.</p>`;
            }
        }

        // Format AI answer with proper HTML
        function formatAIAnswer(text) {
            // Convert markdown-style bold to HTML
            let formatted = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Convert inline code
            formatted = formatted.replace(/`(.+?)`/g, '<code>$1</code>');

            // Split into lines for processing
            let lines = formatted.split('\n');
            let html = [];
            let inList = false;
            let listType = null;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                // Handle bullet points
                if (line.match(/^[-‚Ä¢*]\s+(.+)/)) {
                    if (!inList) {
                        html.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    } else if (listType !== 'ul') {
                        html.push(`</${listType}>`);
                        html.push('<ul>');
                        listType = 'ul';
                    }
                    html.push(`<li>${line.replace(/^[-‚Ä¢*]\s+/, '')}</li>`);
                }
                // Handle numbered lists
                else if (line.match(/^\d+\.\s+(.+)/)) {
                    if (!inList) {
                        html.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    } else if (listType !== 'ol') {
                        html.push(`</${listType}>`);
                        html.push('<ol>');
                        listType = 'ol';
                    }
                    html.push(`<li>${line.replace(/^\d+\.\s+/, '')}</li>`);
                }
                // Handle regular paragraphs
                else if (line.length > 0) {
                    if (inList) {
                        html.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                    }

                    // Check for special indicators
                    if (line.toLowerCase().includes('key takeaway') ||
                        line.toLowerCase().includes('important:')) {
                        html.push(`<div class="key-takeaway">‚ú® ${line}</div>`);
                    } else if (line.toLowerCase().includes('üìä visual aid') ||
                               line.toLowerCase().includes('visual:') ||
                               line.toLowerCase().includes('diagram:')) {
                        html.push(`<div class="visual-suggestion">${line}</div>`);
                    } else if (line.toLowerCase().includes('note:') ||
                               line.toLowerCase().includes('supplemented with')) {
                        html.push(`<div class="insufficient-info">‚ÑπÔ∏è ${line}</div>`);
                    } else {
                        html.push(`<p>${line}</p>`);
                    }
                }
                // Empty line
                else if (inList) {
                    html.push(`</${listType}>`);
                    inList = false;
                    listType = null;
                }
            }

            // Close any remaining list
            if (inList) {
                html.push(`</${listType}>`);
            }

            return html.join('');
        }

        // Calculate similarity between two strings (simple approach)
        function calculateSimilarity(str1, str2) {
            const words1 = new Set(str1.toLowerCase().split(/\s+/));
            const words2 = new Set(str2.toLowerCase().split(/\s+/));
            const intersection = new Set([...words1].filter(x => words2.has(x)));
            const union = new Set([...words1, ...words2]);
            return intersection.size / union.size;
        }

        // Generate interview questions using AI
        async function generateQuestions() {
            const questionsDiv = document.getElementById('generated-questions');
            questionsDiv.innerHTML = '<div class="loading">ü§î Generating questions...</div>';

            try {
                // Get total count of documents first
                const { count } = await supabase
                    .from('documents')
                    .select('*', { count: 'exact', head: true });

                // Generate a random offset to get different chunks each time
                const randomOffset = Math.floor(Math.random() * (count - 20));

                // Get random samples from the database to analyze
                const { data, error } = await supabase
                    .from('documents')
                    .select('*')
                    .range(randomOffset, randomOffset + 19)
                    .limit(20);

                if (error) throw error;

                // Shuffle the data for extra randomness
                const shuffledData = data.sort(() => Math.random() - 0.5);

                // Extract topics and concepts from random chunks
                const allContent = shuffledData.map(d => d.content).join(' ');
                const topics = extractTopics(allContent);

                // Generate questions using free Groq AI API
                const questions = await generateQuestionsWithAI(topics, allContent.substring(0, 2000));

                // Display questions
                displayQuestions(questions);

            } catch (error) {
                questionsDiv.innerHTML = `<div class="loading">Error generating questions: ${error.message}</div>`;
            }
        }

        // Extract key topics from content
        function extractTopics(content) {
            // Common data science topics
            const topicKeywords = [
                'machine learning', 'neural network', 'regression', 'classification',
                'clustering', 'deep learning', 'statistics', 'probability', 'python',
                'data cleaning', 'feature engineering', 'cross validation', 'overfitting',
                'gradient descent', 'decision tree', 'random forest', 'SVM', 'PCA',
                'supervised learning', 'unsupervised learning', 'bias', 'variance'
            ];

            const foundTopics = topicKeywords.filter(topic =>
                content.toLowerCase().includes(topic)
            );

            return foundTopics.slice(0, 5); // Return top 5 topics found
        }

        // Generate questions using free Groq AI API
        async function generateQuestionsWithAI(topics, sampleContent) {
            // Get your free API key from: https://console.groq.com/keys
            const GROQ_API_KEY = 'YOUR_GROQ_API_KEY_HERE'; // Free Groq API key

            // Get selected difficulty
            const selectedDifficulty = document.getElementById('difficulty-select').value;

            // Build difficulty-specific prompt
            let difficultyInstruction = '';
            if (selectedDifficulty === 'easy') {
                difficultyInstruction = 'Generate 5 EASY level questions - focus on basic definitions, fundamental concepts, and simple explanations. Suitable for beginners.';
            } else if (selectedDifficulty === 'medium') {
                difficultyInstruction = 'Generate 5 MEDIUM level questions - focus on understanding concepts, comparisons, and practical applications. Suitable for intermediate learners.';
            } else if (selectedDifficulty === 'hard') {
                difficultyInstruction = 'Generate 5 HARD level questions - focus on complex scenarios, edge cases, implementation details, and advanced concepts. Suitable for experts.';
            } else {
                difficultyInstruction = 'Generate 5 diverse interview questions with mixed difficulty levels (easy, medium, hard).';
            }

            const prompt = `Based on these data science topics: ${topics.join(', ')},
${difficultyInstruction}
Include a mix of conceptual, practical, and scenario-based questions.
Format each question on a new line starting with a number.
Make them challenging but clear.

Example format:
1. What is the difference between supervised and unsupervised learning?
2. How would you handle missing data in a dataset?
3. Explain the bias-variance tradeoff.

Generate 5 questions now:`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        temperature: 1.2,  // Higher for more variety
                        max_tokens: 500,
                        top_p: 0.9
                    })
                });

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error.message);
                }

                const generatedText = result.choices[0].message.content;

                // Parse questions from response
                const questionLines = generatedText.split('\n').filter(line =>
                    line.match(/^\d+\./)
                );

                return questionLines.map(line => {
                    const match = line.match(/^\d+\.\s*(.+)$/);
                    return match ? match[1].trim() : line.trim();
                });

            } catch (error) {
                console.error('AI generation failed:', error);
                // Fallback to predefined questions
                return [
                    'What is the difference between supervised and unsupervised learning?',
                    'Explain the bias-variance tradeoff in machine learning',
                    'How do you handle imbalanced datasets?',
                    'What is regularization and why is it important?',
                    'Explain the concept of cross-validation'
                ];
            }
        }

        // Display generated questions with click-to-search
        function displayQuestions(questions) {
            const questionsDiv = document.getElementById('generated-questions');

            // Get selected difficulty
            const selectedDifficulty = document.getElementById('difficulty-select').value;

            let difficulties;
            if (selectedDifficulty === 'random') {
                // Randomly assign difficulties for variety
                const difficultyOptions = ['easy', 'medium', 'hard'];
                difficulties = questions.map(() =>
                    difficultyOptions[Math.floor(Math.random() * difficultyOptions.length)]
                );
            } else {
                // All questions have the same selected difficulty
                difficulties = questions.map(() => selectedDifficulty);
            }

            questionsDiv.innerHTML = questions.map((question, index) => `
                <div class="question-card" onclick="searchQuestion('${question.replace(/'/g, "\\'")}')">
                    <span class="question-number">Q${index + 1}</span>
                    <span class="question-text">${question}</span>
                    <span class="difficulty-badge difficulty-${difficulties[index]}">${difficulties[index].toUpperCase()}</span>
                </div>
            `).join('');
        }

        // Search for a question when clicked
        function searchQuestion(question) {
            document.getElementById('query').value = question;
            search();
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        async function search() {
            const query = document.getElementById('query').value.trim();
            if (!query) return;

            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">Searching...</div>';

            try {
                // Extract meaningful keywords from the query
                const keywords = extractKeywords(query);

                if (keywords.length === 0) {
                    results.innerHTML = '<div class="loading">Please enter a more specific search query.</div>';
                    return;
                }

                // Search for documents containing ANY of the keywords
                let allResults = [];

                for (const keyword of keywords) {
                    const { data, error } = await supabase
                        .from('documents')
                        .select('*')
                        .ilike('content', `%${keyword}%`)
                        .limit(50);

                    if (error) throw error;
                    if (data) allResults = allResults.concat(data);
                }

                // Remove duplicates based on unique identifiers
                const uniqueResults = Array.from(
                    new Map(allResults.map(item => [`${item.book_name}-${item.page_number}`, item])).values()
                );

                if (uniqueResults.length === 0) {
                    results.innerHTML = `<div class="loading">No results found for "${query}".<br>Try rephrasing or using different keywords.</div>`;
                    return;
                }

                // Calculate relevance score for each result
                const scoredResults = uniqueResults.map(item => ({
                    ...item,
                    relevance: calculateRelevance(item.content, keywords)
                }));

                // Sort by relevance score (highest first)
                scoredResults.sort((a, b) => b.relevance - a.relevance);

                // Take top 20 results
                const topResults = scoredResults.slice(0, 20);

                // Show loading state while AI generates answer
                results.innerHTML = '<div class="loading">ü§ñ AI is analyzing your question and generating a detailed answer...</div>';

                // Compose a coherent answer from top results using AI
                const { answer, sources } = await composeAnswer(topResults, keywords, query);

                // Display AI-generated answer
                results.innerHTML = `
                    <div class="answer-box">
                        <h2>üí° Answer to: "${query}"</h2>
                        <div class="answer-content">
                            ${answer}
                        </div>
                    </div>

                    <div class="sources">
                        <h3>üìö Sources (${sources.length} books referenced)</h3>
                        ${sources.map(source => `
                            <div class="source-item">
                                <div class="source-book">
                                    üìñ ${source.book} - Chunk ${source.chunk}
                                </div>
                                <div class="source-text">"${source.excerpt.substring(0, 200)}..."</div>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                results.innerHTML = `<div class="loading">Error: ${error.message}<br><br>Make sure you've updated the credentials!</div>`;
            }
        }
    </script>
</body>
</html>
