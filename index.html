<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Science Search</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #ffffff;
            --bg-secondary: #f8f9fa;
            --text: #1a1a1a;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --accent: #6366f1;
            --accent-light: #818cf8;
        }

        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-secondary: #171717;
            --text: #f5f5f5;
            --text-light: #a3a3a3;
            --border: #262626;
            --accent: #818cf8;
            --accent-light: #a5b4fc;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s;
        }

        /* Navbar */
        .navbar {
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .profile-btn, .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            color: var(--text);
        }

        .profile-btn:hover, .theme-toggle:hover {
            background: var(--bg-secondary);
        }

        /* Profile Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg);
            border-radius: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .form-hint {
            display: block;
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .radio-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .radio-option {
            flex: 1;
            min-width: 150px;
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option label {
            display: block;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .radio-option input[type="radio"]:checked + label {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        .radio-option label:hover {
            border-color: var(--accent-light);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .checkbox-option {
            position: relative;
        }

        .checkbox-option input[type="checkbox"] {
            display: none;
        }

        .checkbox-option label {
            display: block;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .checkbox-option input[type="checkbox"]:checked + label {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        .checkbox-option label:hover {
            border-color: var(--accent-light);
        }

        .company-select {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .company-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 2.5rem;
            padding: 0.5rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
        }

        .company-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--accent);
            color: white;
            border-radius: 1rem;
            font-size: 0.875rem;
        }

        .company-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
        }

        .company-dropdown {
            position: relative;
        }

        .company-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .company-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .company-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .company-options.active {
            display: block;
        }

        .company-option {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .company-option:hover {
            background: var(--bg-secondary);
        }

        .date-mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .date-mode-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .date-mode-btn.active {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        .date-input-wrapper {
            display: none;
        }

        .date-input-wrapper.active {
            display: block;
        }

        input[type="date"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Main */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 4rem 2rem;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .subtitle {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 3rem;
        }

        /* Profile Summary */
        .profile-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        .profile-info {
            flex: 1;
        }

        .profile-row {
            display: flex;
            gap: 2rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .profile-item {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.9rem;
        }

        .profile-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .profile-value {
            color: var(--text);
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .profile-tag {
            padding: 0.25rem 0.75rem;
            background: var(--accent);
            color: white;
            border-radius: 1rem;
            font-size: 0.8rem;
        }

        .countdown-box {
            text-align: center;
            padding: 1rem 1.5rem;
            background: var(--bg);
            border: 2px solid var(--accent);
            border-radius: 0.75rem;
            min-width: 150px;
        }

        .countdown-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .countdown-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
        }

        .countdown-unit {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .profile-summary {
                flex-direction: column;
                align-items: stretch;
            }

            .countdown-box {
                width: 100%;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            max-height: 100px;
            opacity: 1;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.5s ease,
                        margin-bottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tabs.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            overflow: hidden;
        }

        .tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Search */
        .search-wrapper {
            transition: none;
        }

        .search-container {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .search-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-icon:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0 3rem 0 1rem;
            height: 48px;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            background: var(--bg);
            color: var(--text);
            outline: none;
            transition: border 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        .clear-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%) scale(0);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--text-light);
            color: var(--bg);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .clear-btn.visible {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }

        .clear-btn:hover {
            background: var(--accent);
            transform: translateY(-50%) scale(1.1);
        }

        /* Question Generator */
        .controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .select {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg);
            color: var(--text);
            font-size: 0.9375rem;
            cursor: pointer;
            outline: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--accent-light);
        }

        /* Question Card */
        .question-card {
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            background: var(--bg);
        }

        .question-card:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .question-card.expanded {
            border-color: var(--accent);
        }

        .question-header {
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .expand-icon {
            font-size: 1.25rem;
            transition: transform 0.3s;
            color: var(--text-light);
        }

        .question-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Answer accordion section */
        .question-answer {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease,
                        padding 0.3s ease;
            padding: 0 1.25rem;
        }

        .question-card.expanded .question-answer {
            max-height: 2000px;
            opacity: 1;
            padding: 0 1.25rem 1.25rem 1.25rem;
        }

        .answer-content {
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }

        .answer-content h4 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--accent);
        }

        .answer-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        .answer-content ul, .answer-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .answer-content li {
            margin-bottom: 0.5rem;
        }

        .answer-content strong {
            color: var(--accent);
        }

        .answer-content code {
            background: var(--bg);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
            border: 1px solid var(--border);
        }

        .answer-loading {
            text-align: center;
            color: var(--text-light);
            padding: 2rem;
        }

        .question-text {
            flex: 1;
            font-size: 0.9375rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-easy { background: #10b981; color: white; }
        .badge-medium { background: #f59e0b; color: white; }
        .badge-hard { background: #ef4444; color: white; }

        /* Answer */
        .answer {
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .answer h3 {
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .answer p {
            margin-bottom: 1rem;
            color: var(--text-light);
        }

        .answer strong {
            color: var(--accent);
        }

        .answer ul, .answer ol {
            margin: 1rem 0 1rem 1.5rem;
        }

        .answer li {
            margin-bottom: 0.5rem;
        }

        /* Diagram */
        .diagram {
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .diagram h3 {
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* Sources */
        .sources {
            margin-top: 2rem;
        }

        .sources h3 {
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .source {
            padding: 1rem;
            border-left: 3px solid var(--accent);
            background: var(--bg-secondary);
            border-radius: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .source-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .source-text {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Empty State */
        .empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
        }

        /* Results Animation */
        #results {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        #results.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        /* Book Carousel */
        .book-carousel {
            position: relative;
            overflow: hidden;
            padding: 2rem 0;
            margin-bottom: 2rem;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            max-height: 300px;
            opacity: 1;
            transition: max-height 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.6s ease,
                        margin-bottom 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .book-carousel.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            overflow: hidden;
        }

        .book-track {
            display: flex;
            gap: 1.5rem;
            animation: scroll 30s linear infinite;
        }

        .book-track:hover {
            animation-play-state: paused;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .book {
            flex-shrink: 0;
            width: 140px;
            height: 200px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .book:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }

        .book img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .title {
                font-size: 2rem;
            }

            .container {
                padding: 2rem 1rem;
            }

            .controls {
                flex-direction: column;
            }

            .question-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .book {
                width: 120px;
                height: 170px;
            }

            .book-title {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">Data Science Interview Coach</div>
        <div class="nav-actions">
            <button class="profile-btn" onclick="openProfileModal()" title="Setup Profile">üë§</button>
            <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>
        </div>
    </nav>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Setup Your Profile</h2>
                <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <!-- Experience Level -->
                    <div class="form-group">
                        <label class="form-label">Experience Level</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="exp-junior" name="experience" value="junior" checked>
                                <label for="exp-junior">Junior<br><small>(0-2 years)</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="exp-mid" name="experience" value="mid">
                                <label for="exp-mid">Mid-level<br><small>(3-5 years)</small></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="exp-senior" name="experience" value="senior">
                                <label for="exp-senior">Senior<br><small>(6+ years)</small></label>
                            </div>
                        </div>
                    </div>

                    <!-- Target Companies -->
                    <div class="form-group">
                        <label class="form-label">Target Companies</label>
                        <span class="form-hint">Select companies you're interviewing with</span>
                        <div class="company-select">
                            <div class="company-tags" id="company-tags">
                                <!-- Selected companies will appear here -->
                            </div>
                            <div class="company-dropdown">
                                <input
                                    type="text"
                                    class="company-input"
                                    id="company-input"
                                    placeholder="Search or add company..."
                                    autocomplete="off"
                                >
                                <div class="company-options" id="company-options">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weak Areas -->
                    <div class="form-group">
                        <label class="form-label">Areas to Focus On</label>
                        <span class="form-hint">Select areas where you need more practice</span>
                        <div class="checkbox-group">
                            <div class="checkbox-option">
                                <input type="checkbox" id="area-coding" value="coding">
                                <label for="area-coding">Coding</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="area-stats" value="stats">
                                <label for="area-stats">Stats Theory</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="area-ml" value="ml">
                                <label for="area-ml">ML Algorithms</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="area-case" value="case">
                                <label for="area-case">Case Studies</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="area-comm" value="communication">
                                <label for="area-comm">Communication</label>
                            </div>
                        </div>
                    </div>

                    <!-- Interview Date -->
                    <div class="form-group">
                        <label class="form-label">Interview Timeline</label>
                        <div class="date-mode-toggle">
                            <button type="button" class="date-mode-btn active" onclick="setDateMode('practice')">Practice Only</button>
                            <button type="button" class="date-mode-btn" onclick="setDateMode('scheduled')">Have Interview Date</button>
                        </div>
                        <div class="date-input-wrapper" id="date-input-wrapper">
                            <input type="date" id="interview-date" name="interview-date">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="container">
        <h1 class="title">Master Data Science Interviews</h1>
        <p class="subtitle">AI-powered practice tailored to your experience and target companies</p>

        <!-- Profile Summary -->
        <div class="profile-summary" id="profile-summary">
            <div class="profile-info">
                <div class="profile-row">
                    <div class="profile-item">
                        <span class="profile-label">Level:</span>
                        <span class="profile-value" id="profile-exp">Junior</span>
                    </div>
                    <div class="profile-item">
                        <span class="profile-label">Target:</span>
                        <span class="profile-value" id="profile-companies">Not set</span>
                    </div>
                </div>
                <div class="profile-row">
                    <div class="profile-item">
                        <span class="profile-label">Focus Areas:</span>
                    </div>
                </div>
                <div class="profile-tags" id="profile-focus">
                    <span class="profile-tag">All Topics</span>
                </div>
            </div>
            <div class="countdown-box" id="countdown-box">
                <div class="countdown-label">Interview In</div>
                <div class="countdown-value" id="countdown-days">--</div>
                <div class="countdown-unit">days</div>
            </div>
        </div>

        <!-- Book Carousel -->
        <div class="book-carousel" id="book-carousel">
            <div class="book-track" id="book-track">
                <!-- Books will be loaded here -->
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('search')">Search</button>
            <button class="tab" onclick="switchTab('questions')">Study Questions</button>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content active">
            <div class="search-wrapper" id="search-wrapper">
                <div class="search-container">
                    <div class="search-icon" onclick="search()">üîç</div>
                    <div class="search-input-wrapper">
                        <input
                            id="query"
                            class="search-input"
                            type="text"
                            placeholder="Ask anything about data science..."
                            autofocus
                        >
                        <button class="clear-btn" id="clear-btn" onclick="clearSearch()">‚úï</button>
                    </div>
                </div>
            </div>
            <div id="results"></div>
        </div>

        <!-- Questions Tab -->
        <div id="questions-tab" class="tab-content">
            <div class="controls">
                <select id="difficulty" class="select">
                    <option value="random">Random Mix</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <select id="question-count" class="select">
                    <option value="5">5 Questions</option>
                    <option value="10">10 Questions</option>
                    <option value="15">15 Questions</option>
                    <option value="20">20 Questions</option>
                </select>
                <button class="btn" onclick="generateQuestions()">Generate</button>
            </div>
            <div id="questions">
                <div class="empty">Click "Generate" to create study questions</div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            theme: document.body.dataset.theme === 'dark' ? 'dark' : 'default'
        });
        window.mermaid = mermaid;
    </script>
    <script>
        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const theme = body.dataset.theme === 'light' ? 'dark' : 'light';
            body.dataset.theme = theme;
            document.getElementById('theme-btn').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', theme);

            if (window.mermaid) {
                window.mermaid.initialize({ theme: theme === 'dark' ? 'dark' : 'default' });
            }
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.dataset.theme = savedTheme;
        document.getElementById('theme-btn').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Update active tab UI
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Called programmatically, update tab buttons manually
                const tabButtons = document.querySelectorAll('.tab');
                if (tab === 'search') tabButtons[0].classList.add('active');
                if (tab === 'questions') tabButtons[1].classList.add('active');
            }

            document.getElementById(`${tab}-tab`).classList.add('active');

            // Update previousTab only when manually switching tabs
            if (event && event.target) {
                previousTab = tab;
            }
        }

        window.switchTab = switchTab;

        // Enter key search
        document.getElementById('query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });

        // Show/hide clear button based on input
        document.getElementById('query').addEventListener('input', (e) => {
            const clearBtn = document.getElementById('clear-btn');
            if (e.target.value.length > 0) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
        });

        // Track which tab user came from (for better navigation)
        let previousTab = 'search';

        // Clear search function - HOME button (goes back to previous tab)
        function clearSearch() {
            const query = document.getElementById('query');
            const results = document.getElementById('results');
            const clearBtn = document.getElementById('clear-btn');
            const carousel = document.getElementById('book-carousel');
            const tabs = document.querySelector('.tabs');

            // Clear input and hide clear button
            query.value = '';
            clearBtn.classList.remove('visible');

            // Fade out results
            results.classList.remove('visible');

            setTimeout(() => {
                results.innerHTML = '';

                // Show everything back (HOME state)
                tabs.classList.remove('hidden');
                carousel.classList.remove('hidden');

                // Switch back to previous tab if it was questions
                if (previousTab === 'questions') {
                    switchTab('questions');
                }
            }, 300);

            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.clearSearch = clearSearch;

        // Extract keywords
        function extractKeywords(query) {
            const stopWords = new Set([
                'what', 'is', 'are', 'the', 'a', 'an', 'how', 'why', 'when', 'where',
                'who', 'which', 'does', 'do', 'can', 'could', 'would', 'should',
                'tell', 'me', 'about', 'explain', 'describe', 'define', 'of', 'in', 'on'
            ]);

            const semanticExpansions = {
                'neural': ['network', 'neuron', 'deep learning', 'backpropagation'],
                'gradient': ['descent', 'backpropagation', 'optimization'],
                'decision': ['tree', 'forest', 'classification'],
                'machine': ['learning', 'ml', 'model', 'algorithm'],
                'deep': ['learning', 'neural', 'network'],
                'regression': ['linear', 'logistic', 'prediction'],
                'classification': ['supervised', 'model', 'predict']
            };

            const words = query.toLowerCase()
                .replace(/[?.,!;:]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 2 && !stopWords.has(word));

            const keywords = new Set(words);
            words.forEach(word => {
                if (semanticExpansions[word]) {
                    semanticExpansions[word].forEach(related => {
                        related.split(' ').forEach(term => {
                            if (term.length > 2) keywords.add(term);
                        });
                    });
                }
            });

            return Array.from(keywords);
        }

        // Calculate relevance
        function calculateRelevance(content, keywords, query = '') {
            const lower = content.toLowerCase();
            let score = 0;

            if (query && lower.includes(query.toLowerCase())) score += 200;

            keywords.forEach((keyword, i) => {
                const weight = i < 3 ? 15 : 8;
                const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                const matches = lower.match(regex);

                if (matches) {
                    score += matches.length * weight;
                    const firstIndex = lower.indexOf(keyword);
                    if (firstIndex < 100) score += 30;
                    else if (firstIndex < 300) score += 15;
                }
            });

            if (content.length < 200) score *= 0.5;
            if (content.length > 500 && content.length < 2000) score *= 1.2;

            return score;
        }

        // Extract sentences
        function extractSentences(content, keywords) {
            const cleaned = content
                .replace(/={10,}/g, '')
                .replace(/PAGE \d+/gi, '')
                .trim();

            const sentences = cleaned.split(/[.!?]+/).filter(s => s.length > 20);
            const scored = sentences.map(sentence => {
                let score = 0;
                const lower = sentence.toLowerCase();
                keywords.forEach(keyword => {
                    if (lower.includes(keyword)) score += 10;
                });
                return { sentence, score };
            });

            return scored
                .filter(s => s.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(s => s.sentence);
        }

        // Compose answer
        async function composeAnswer(results, keywords, query) {
            const sources = [];
            let context = '';

            results.slice(0, 10).forEach(item => {
                const sentences = extractSentences(item.content, keywords);
                if (sentences.length > 0) {
                    context += `\n[From: ${item.book_name}]\n${sentences.slice(0, 6).join(' ')}\n`;
                    sources.push({
                        book: item.book_name,
                        chunk: item.page_number,
                        excerpt: sentences[0]
                    });
                }
            });

            if (!context.trim()) {
                return {
                    answer: '<p>No relevant information found. Try different keywords.</p>',
                    sources: []
                };
            }

            const aiAnswer = await generateAIAnswer(query, context);
            return { answer: aiAnswer, sources: sources.slice(0, 5) };
        }

        // Generate AI answer
        async function generateAIAnswer(question, context) {
            const GROQ_API_KEY = CONFIG.GROQ_API_KEY;

            if (!GROQ_API_KEY || GROQ_API_KEY === 'YOUR_GROQ_API_KEY_HERE') {
                return '<p>‚ö†Ô∏è Please add your Groq API key to config.js</p>';
            }

            const prompt = `You are a Data Science expert. Answer the student's question using the book excerpts provided.

Instructions:
- Use **bold** for key terms
- Be clear and concise
- Include a Mermaid diagram if helpful, using this format:

[MERMAID_DIAGRAM]
graph TD
    A[Start] --> B[Process]
[/MERMAID_DIAGRAM]

Question: "${question}"

Book Excerpts:
${context}

Answer:`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7,
                        max_tokens: 1500
                    })
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error.message);

                return formatAnswer(result.choices[0].message.content);
            } catch (error) {
                return `<p>‚ö†Ô∏è Error: ${error.message}</p>`;
            }
        }

        // Format answer
        function formatAnswer(text) {
            const diagramRegex = /\[MERMAID_DIAGRAM\]([\s\S]*?)\[\/MERMAID_DIAGRAM\]/;
            const match = text.match(diagramRegex);
            let diagram = null;
            let content = text;

            if (match) {
                diagram = match[1].trim();
                content = text.replace(diagramRegex, '').trim();
            }

            let formatted = content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.+?)`/g, '<code>$1</code>');

            const lines = formatted.split('\n');
            let html = [];
            let inList = false;
            let listType = null;

            for (let line of lines) {
                line = line.trim();

                if (line.match(/^[-‚Ä¢*]\s+(.+)/)) {
                    if (!inList) {
                        html.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    html.push(`<li>${line.replace(/^[-‚Ä¢*]\s+/, '')}</li>`);
                } else if (line.match(/^\d+\.\s+(.+)/)) {
                    if (!inList) {
                        html.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    html.push(`<li>${line.replace(/^\d+\.\s+/, '')}</li>`);
                } else if (line.length > 0) {
                    if (inList) {
                        html.push(`</${listType}>`);
                        inList = false;
                    }
                    html.push(`<p>${line}</p>`);
                } else if (inList) {
                    html.push(`</${listType}>`);
                    inList = false;
                }
            }

            if (inList) html.push(`</${listType}>`);

            return { html: html.join(''), diagram };
        }

        // Search
        async function search() {
            const query = document.getElementById('query').value.trim();
            if (!query) return;

            const results = document.getElementById('results');
            const carousel = document.getElementById('book-carousel');
            const tabs = document.querySelector('.tabs');

            // Hide everything - tabs and carousel smoothly
            tabs.classList.add('hidden');
            carousel.classList.add('hidden');

            // Fade out old results
            results.classList.remove('visible');

            setTimeout(() => {
                results.innerHTML = '<div class="loading">Searching...</div>';
                results.classList.add('visible');
            }, 300);

            try {
                const keywords = extractKeywords(query);
                if (keywords.length === 0) {
                    results.innerHTML = '<div class="empty">Please enter a more specific query</div>';
                    return;
                }

                let allResults = [];
                for (const keyword of keywords) {
                    const { data, error } = await supabase
                        .from('documents')
                        .select('*')
                        .ilike('content', `%${keyword}%`)
                        .limit(50);

                    if (error) throw error;
                    if (data) allResults = allResults.concat(data);
                }

                const unique = Array.from(
                    new Map(allResults.map(item => [`${item.book_name}-${item.page_number}`, item])).values()
                );

                if (unique.length === 0) {
                    results.innerHTML = '<div class="empty">No results found</div>';
                    return;
                }

                const scored = unique
                    .map(item => ({ ...item, relevance: calculateRelevance(item.content, keywords, query) }))
                    .sort((a, b) => b.relevance - a.relevance)
                    .slice(0, 20);

                results.classList.remove('visible');

                setTimeout(() => {
                    results.innerHTML = '<div class="loading">Generating answer...</div>';
                    results.classList.add('visible');
                }, 300);

                const { answer, sources } = await composeAnswer(scored, keywords, query);

                results.classList.remove('visible');

                setTimeout(async () => {
                    let html = `<div class="answer">
                        <h3>Answer</h3>
                        ${answer.html}
                    </div>`;

                    if (answer.diagram) {
                        html += `<div class="diagram">
                            <h3>Diagram</h3>
                            <div class="mermaid" id="diagram">${answer.diagram}</div>
                        </div>`;
                    }

                    if (sources.length > 0) {
                        html += '<div class="sources"><h3>Sources</h3>';
                        sources.forEach(source => {
                            html += `<div class="source">
                                <div class="source-title">${source.book} - Chunk ${source.chunk}</div>
                                <div class="source-text">${source.excerpt.substring(0, 200)}...</div>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    results.innerHTML = html;
                    results.classList.add('visible');

                    if (answer.diagram && window.mermaid) {
                        await window.mermaid.run({ querySelector: '#diagram' });
                    }

                    // Smooth scroll to results
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                }, 300);

            } catch (error) {
                results.innerHTML = `<div class="empty">Error: ${error.message}</div>`;
                results.classList.add('visible');
            }
        }

        window.search = search;

        // Company-specific question patterns
        const COMPANY_PATTERNS = {
            'Meta': 'Meta/Facebook focuses on: A/B testing, metrics design, product analytics, causal inference, and SQL optimization. Emphasize practical scenarios with real user data.',
            'Google': 'Google emphasizes: scalability, distributed systems, algorithm optimization, statistics fundamentals, and system design. Questions should involve large-scale thinking.',
            'Amazon': 'Amazon focuses on: customer obsession, leadership principles applied to data, SQL expertise, bias in ML models, and practical business impact. Include behavioral aspects.',
            'Apple': 'Apple emphasizes: privacy-preserving ML, on-device analytics, production ML systems, and elegant solutions to complex problems.',
            'Netflix': 'Netflix focuses on: experimentation at scale, recommendation systems, personalization, streaming data analytics, and causal inference.',
            'Microsoft': 'Microsoft emphasizes: Azure ML, productionizing models, MLOps, statistics, and traditional CS fundamentals with data science.',
            'Tesla': 'Tesla focuses on: computer vision, real-time ML, autonomous systems, time-series analysis, and sensor data processing.',
            'Uber': 'Uber emphasizes: marketplace dynamics, geospatial analysis, surge pricing algorithms, experimentation, and real-time systems.',
            'Airbnb': 'Airbnb focuses on: trust & safety ML, search ranking, pricing optimization, experimentation, and user behavior analytics.',
            'LinkedIn': 'LinkedIn emphasizes: recommendation systems, network effects, feed ranking, NLP, and professional network analytics.',
            'Spotify': 'Spotify focuses on: recommendation systems, audio processing, personalization at scale, and user engagement metrics.',
            'McKinsey': 'McKinsey emphasizes: business case analysis, hypothesis-driven problem solving, client communication, and ROI-focused analytics.',
            'BCG': 'BCG focuses on: strategic analytics, market sizing, competitive analysis, and translating data insights to C-suite recommendations.',
            'Goldman Sachs': 'Goldman Sachs emphasizes: quantitative finance, risk modeling, time-series forecasting, algorithmic trading, and regulatory compliance.',
            'JP Morgan': 'JP Morgan focuses on: credit risk modeling, fraud detection, financial forecasting, and large-scale data infrastructure.'
        };

        // Experience-level adjustments
        const EXPERIENCE_CONTEXT = {
            'junior': {
                prefix: 'for a JUNIOR data scientist (0-2 years experience)',
                focus: 'Focus on foundational concepts, definitions, when to use different techniques, and basic implementation questions. Keep scenarios straightforward.',
                complexity: 'Questions should test understanding of core concepts without requiring deep experience.'
            },
            'mid': {
                prefix: 'for a MID-LEVEL data scientist (3-5 years experience)',
                focus: 'Focus on practical tradeoffs, debugging production issues, choosing between approaches, and cross-functional collaboration.',
                complexity: 'Questions should involve real-world complexity, multiple valid approaches, and business context.'
            },
            'senior': {
                prefix: 'for a SENIOR data scientist (6+ years experience)',
                focus: 'Focus on architecture decisions, team leadership, strategic impact, scaling systems, and mentoring scenarios.',
                complexity: 'Questions should involve ambiguity, stakeholder management, long-term technical decisions, and org-level impact.'
            }
        };

        // Topic-specific instructions
        const TOPIC_INSTRUCTIONS = {
            'coding': 'Include Python/SQL coding problems, data manipulation challenges, algorithm implementation.',
            'stats': 'Include statistics and probability questions. For mathematical questions, provide ONLY the formula/theorem needed - DO NOT solve the problem. Format: "Question? [Formula: formula here]"',
            'ml': 'Include machine learning algorithms, model selection, hyperparameter tuning, evaluation metrics.',
            'case': 'Include business case studies, metric design, A/B test interpretation, stakeholder scenarios.',
            'communication': 'Include explaining technical concepts to non-technical stakeholders, presenting findings, handling objections.'
        };

        // Generate Questions with Profile Intelligence
        async function generateQuestions() {
            const questionsDiv = document.getElementById('questions');
            questionsDiv.innerHTML = '<div class="loading">Generating personalized questions...</div>';

            try {
                const difficulty = document.getElementById('difficulty').value;
                const questionCount = parseInt(document.getElementById('question-count').value);

                // Build personalized instruction based on profile
                let instruction = buildPersonalizedInstruction(difficulty, questionCount);

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{ role: 'user', content: instruction }],
                        temperature: 0.9,
                        max_tokens: questionCount * 60 // Scale tokens with question count
                    })
                });

                const result = await response.json();
                const text = result.choices[0].message.content;
                const questions = text.split('\n').filter(line => line.match(/^\d+\./));

                displayQuestions(questions, difficulty);
            } catch (error) {
                questionsDiv.innerHTML = `<div class="empty">Error: ${error.message}</div>`;
            }
        }

        // Build personalized instruction based on user profile
        function buildPersonalizedInstruction(difficulty, questionCount = 5) {
            const exp = userProfile.experience || 'junior';
            const companies = userProfile.companies || [];
            const weakAreas = userProfile.weakAreas || [];
            const interviewDate = userProfile.interviewDate;
            const mode = userProfile.interviewMode;

            // Start with base instruction
            let instruction = `Generate ${questionCount} data science interview questions ${EXPERIENCE_CONTEXT[exp].prefix}. Each question must be a complete question ending with a question mark.\n\n`;

            // Add difficulty context
            const difficultyMap = {
                'easy': 'EASY/FOUNDATIONAL level',
                'medium': 'MEDIUM/INTERMEDIATE level',
                'hard': 'HARD/ADVANCED level',
                'random': 'MIXED difficulty levels (easy, medium, hard)'
            };
            instruction += `Difficulty: ${difficultyMap[difficulty] || 'MEDIUM'}.\n\n`;

            // Add experience-level context
            instruction += `${EXPERIENCE_CONTEXT[exp].focus}\n${EXPERIENCE_CONTEXT[exp].complexity}\n\n`;

            // Add company-specific context if set
            if (companies.length > 0) {
                const primaryCompany = companies[0];
                const companyContext = COMPANY_PATTERNS[primaryCompany];

                if (companyContext) {
                    instruction += `Target Company: ${primaryCompany}\n${companyContext}\n\n`;
                } else {
                    instruction += `Target Company: ${primaryCompany}\nTailor questions to this company's known interview style and domain.\n\n`;
                }

                if (companies.length > 1) {
                    instruction += `Also preparing for: ${companies.slice(1, 3).join(', ')}\n\n`;
                }
            }

            // Add focus area weighting (CRITICAL for personalization)
            if (weakAreas.length > 0) {
                instruction += `FOCUS AREAS (user needs practice in these): ${weakAreas.map(a => a.toUpperCase()).join(', ')}\n`;
                instruction += `Generate MORE questions from these weak areas. `;

                // Add topic-specific instructions
                weakAreas.forEach(area => {
                    if (TOPIC_INSTRUCTIONS[area]) {
                        instruction += `${TOPIC_INSTRUCTIONS[area]} `;
                    }
                });
                instruction += '\n\n';

                // Special handling for stats/math questions
                if (weakAreas.includes('stats')) {
                    instruction += `IMPORTANT: For statistics/probability/math questions, provide the relevant formula or theorem but DO NOT calculate the answer. Format as: "Question? [Formula: relevant formula]"\n\n`;
                }
            } else {
                instruction += `Cover a balanced mix of: coding, statistics, ML algorithms, case studies, and communication.\n\n`;
            }

            // Add urgency context if interview is scheduled
            if (mode === 'scheduled' && interviewDate) {
                const today = new Date();
                const interview = new Date(interviewDate);
                const daysLeft = Math.ceil((interview - today) / (1000 * 60 * 60 * 24));

                if (daysLeft <= 7) {
                    instruction += `‚ö†Ô∏è URGENT: Interview is in ${daysLeft} days! Focus on high-impact, commonly asked questions.\n\n`;
                } else if (daysLeft <= 30) {
                    instruction += `Interview is in ${daysLeft} days. Prioritize practical, scenario-based questions.\n\n`;
                }
            }

            // Final formatting instruction
            instruction += `Format your response as a numbered list (1. Question? 2. Question? etc.) with ${questionCount} total questions. Each question must end with a question mark.`;

            console.log('Generated instruction:', instruction); // Debug
            return instruction;
        }

        window.generateQuestions = generateQuestions;

        // Display Questions with Accordion
        function displayQuestions(questions, difficulty) {
            const questionsDiv = document.getElementById('questions');
            const difficulties = difficulty === 'random'
                ? questions.map(() => ['easy', 'medium', 'hard'][Math.floor(Math.random() * 3)])
                : questions.map(() => difficulty);

            questionsDiv.innerHTML = questions.map((q, i) => {
                // Clean up the question text - remove numbering and markdown formatting
                let text = q.replace(/^\d+\.\s*/, ''); // Remove numbering
                text = text.replace(/\*\*/g, ''); // Remove ** markdown bold
                text = text.replace(/\*/g, ''); // Remove * markdown italic
                text = text.replace(/`/g, ''); // Remove ` code formatting
                text = text.trim();

                return `<div class="question-card" id="question-${i}">
                    <div class="question-header" onclick="toggleQuestionAnswer(${i}, '${text.replace(/'/g, "\\'")}')">
                        <div class="question-text">${text}</div>
                        <div class="question-actions">
                            <span class="badge badge-${difficulties[i]}">${difficulties[i]}</span>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                    </div>
                    <div class="question-answer" id="answer-${i}">
                        <!-- Answer will be loaded here -->
                    </div>
                </div>`;
            }).join('');
        }

        // Toggle Question Answer (Accordion)
        async function toggleQuestionAnswer(index, questionText) {
            const card = document.getElementById(`question-${index}`);
            const answerDiv = document.getElementById(`answer-${index}`);

            // If already expanded, collapse it
            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                return;
            }

            // Collapse all other questions first
            document.querySelectorAll('.question-card').forEach(c => c.classList.remove('expanded'));

            // Expand this question
            card.classList.add('expanded');

            // If answer already fetched, don't fetch again
            if (answerDiv.dataset.loaded === 'true') {
                return;
            }

            // Show loading state
            answerDiv.innerHTML = '<div class="answer-loading">Loading answer...</div>';

            try {
                // Fetch answer using existing search logic
                const keywords = extractKeywords(questionText);

                const { data, error } = await supabase
                    .from('documents')
                    .select('*');

                if (error) throw error;

                // Score and rank results
                const scored = data
                    .map(doc => ({
                        ...doc,
                        score: calculateRelevance(doc.content, keywords, questionText)
                    }))
                    .filter(doc => doc.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 5);

                // Generate answer
                const { answer } = await composeAnswer(scored, keywords, questionText);

                // Display answer
                answerDiv.innerHTML = `<div class="answer-content">${answer.html}</div>`;
                answerDiv.dataset.loaded = 'true';

            } catch (error) {
                answerDiv.innerHTML = `<div class="answer-content"><p style="color: #ef4444;">Error loading answer: ${error.message}</p></div>`;
            }
        }

        window.toggleQuestionAnswer = toggleQuestionAnswer;

        // Search Question (kept for backwards compatibility, but not used in new accordion UI)
        function searchQuestion(question) {
            // Remember we came from questions tab
            previousTab = 'questions';

            switchTab('search');
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');

            // Set query and show clear button
            const queryInput = document.getElementById('query');
            const clearBtn = document.getElementById('clear-btn');
            queryInput.value = question;
            clearBtn.classList.add('visible'); // Show the clear button

            search();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.searchQuestion = searchQuestion;

        // Book cover image mapping - all available books
        const allBooks = [
            { name: 'A Mathematical Introduction to Data Science', cover: 'book-covers/mathematical-intro.jpg' },
            { name: 'Data Science: An Introduction to Statistics and Machine Learning', cover: 'book-covers/data-science.jpg' },
            { name: 'Data Science in Practice', cover: 'book-covers/data-science-practice.jpg' },
            { name: 'Data Science: Foundations and Hands-on Experience', cover: 'book-covers/data-science-foundations.jpg' },
            { name: 'Introduction to Data Science', cover: 'book-covers/intro-data-science.jpg' },
            { name: 'Materials Data Science', cover: 'book-covers/materials-data-science.jpg' },
            { name: 'Python for Data Science', cover: 'book-covers/python-data-science.jpg' }
        ];

        // Search for book summary
        async function searchBookSummary(bookName) {
            // Switch to search tab
            switchTab('search');
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');

            // Set query - just the book name (short and clean)
            document.getElementById('query').value = bookName;

            // Trigger clear button visibility
            document.getElementById('clear-btn').classList.add('visible');

            // Perform search with full query but display short name
            const results = document.getElementById('results');
            const carousel = document.getElementById('book-carousel');
            const tabs = document.querySelector('.tabs');

            // Hide everything - tabs and carousel smoothly
            tabs.classList.add('hidden');
            carousel.classList.add('hidden');

            // Fade out old results
            results.classList.remove('visible');

            setTimeout(() => {
                results.innerHTML = '<div class="loading">Searching...</div>';
                results.classList.add('visible');
            }, 300);

            try {
                // Use full query for actual search
                const fullQuery = `Give me a summary of the book "${bookName}" including author, key topics, and what it covers`;
                const keywords = extractKeywords(fullQuery);

                let allResults = [];
                for (const keyword of keywords) {
                    const { data, error } = await supabase
                        .from('documents')
                        .select('*')
                        .ilike('content', `%${keyword}%`)
                        .limit(50);

                    if (error) throw error;
                    if (data) allResults = allResults.concat(data);
                }

                const unique = Array.from(
                    new Map(allResults.map(item => [`${item.book_name}-${item.page_number}`, item])).values()
                );

                if (unique.length === 0) {
                    results.innerHTML = '<div class="empty">No results found</div>';
                    return;
                }

                const scored = unique
                    .map(item => ({ ...item, relevance: calculateRelevance(item.content, keywords, fullQuery) }))
                    .sort((a, b) => b.relevance - a.relevance)
                    .slice(0, 20);

                results.classList.remove('visible');

                setTimeout(() => {
                    results.innerHTML = '<div class="loading">Generating answer...</div>';
                    results.classList.add('visible');
                }, 300);

                const { answer, sources } = await composeAnswer(scored, keywords, fullQuery);

                results.classList.remove('visible');

                setTimeout(async () => {
                    let html = `<div class="answer">
                        <h3>Answer</h3>
                        ${answer.html}
                    </div>`;

                    if (answer.diagram) {
                        html += `<div class="diagram">
                            <h3>Diagram</h3>
                            <div class="mermaid" id="diagram">${answer.diagram}</div>
                        </div>`;
                    }

                    if (sources.length > 0) {
                        html += '<div class="sources"><h3>Sources</h3>';
                        sources.forEach(source => {
                            html += `<div class="source">
                                <div class="source-title">${source.book} - Chunk ${source.chunk}</div>
                                <div class="source-text">${source.excerpt.substring(0, 200)}...</div>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    results.innerHTML = html;
                    results.classList.add('visible');

                    if (answer.diagram && window.mermaid) {
                        await window.mermaid.run({ querySelector: '#diagram' });
                    }

                    // Smooth scroll to results
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                }, 300);

            } catch (error) {
                results.innerHTML = `<div class="empty">Error: ${error.message}</div>`;
                results.classList.add('visible');
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load Book Carousel
        async function loadBookCarousel() {
            try {
                const track = document.getElementById('book-track');

                // Create book cards from all available books
                const bookCards = allBooks.map(book => {
                    return `
                        <div class="book" onclick="searchBookSummary('${book.name.replace(/'/g, "\\'")}')">
                            <img src="${book.cover}" alt="${book.name}">
                        </div>
                    `;
                }).join('');

                // Duplicate the books to create seamless loop
                track.innerHTML = bookCards + bookCards;

            } catch (error) {
                console.error('Error loading books:', error);
                document.getElementById('book-carousel').style.display = 'none';
            }
        }

        window.searchBookSummary = searchBookSummary;

        // Load carousel on page load
        loadBookCarousel();

        // ========================================
        // PROFILE MANAGEMENT
        // ========================================

        // Company list
        const COMPANIES = [
            'Meta', 'Google', 'Amazon', 'Apple', 'Netflix', 'Microsoft',
            'Tesla', 'NVIDIA', 'Uber', 'Airbnb', 'Spotify', 'LinkedIn',
            'Salesforce', 'Adobe', 'Oracle', 'IBM', 'Intel', 'Cisco',
            'Twitter/X', 'Snap', 'Pinterest', 'Dropbox', 'Stripe', 'Square',
            'Goldman Sachs', 'JP Morgan', 'Morgan Stanley', 'McKinsey', 'BCG', 'Bain'
        ];

        let selectedCompanies = [];
        let userProfile = {
            experience: 'junior',
            companies: [],
            weakAreas: [],
            interviewMode: 'practice',
            interviewDate: null
        };

        // Load profile from localStorage
        function loadProfile() {
            const saved = localStorage.getItem('userProfile');
            if (saved) {
                userProfile = JSON.parse(saved);
                updateProfileDisplay();
            }
        }

        // Update profile summary display
        function updateProfileDisplay() {
            // Update experience level
            const expMap = {
                'junior': 'Junior (0-2 years)',
                'mid': 'Mid-level (3-5 years)',
                'senior': 'Senior (6+ years)'
            };
            document.getElementById('profile-exp').textContent = expMap[userProfile.experience] || 'Junior';

            // Update companies
            const companiesEl = document.getElementById('profile-companies');
            if (userProfile.companies.length === 0) {
                companiesEl.textContent = 'Not set';
            } else if (userProfile.companies.length <= 2) {
                companiesEl.textContent = userProfile.companies.join(', ');
            } else {
                companiesEl.textContent = `${userProfile.companies.slice(0, 2).join(', ')} +${userProfile.companies.length - 2} more`;
            }

            // Update focus areas
            const focusEl = document.getElementById('profile-focus');
            const areaMap = {
                'coding': 'Coding',
                'stats': 'Stats Theory',
                'ml': 'ML Algorithms',
                'case': 'Case Studies',
                'communication': 'Communication'
            };

            if (userProfile.weakAreas.length === 0) {
                focusEl.innerHTML = '<span class="profile-tag">All Topics</span>';
            } else {
                focusEl.innerHTML = userProfile.weakAreas.map(area =>
                    `<span class="profile-tag">${areaMap[area] || area}</span>`
                ).join('');
            }

            // Update countdown
            updateCountdown();
        }

        // Calculate and display countdown
        function updateCountdown() {
            const countdownBox = document.getElementById('countdown-box');
            const countdownLabel = countdownBox.querySelector('.countdown-label');
            const countdownValue = document.getElementById('countdown-days');
            const countdownUnit = countdownBox.querySelector('.countdown-unit');

            if (userProfile.interviewMode === 'practice' || !userProfile.interviewDate) {
                countdownLabel.textContent = 'Mode';
                countdownValue.textContent = '‚àû';
                countdownUnit.textContent = 'practice';
                countdownBox.style.borderColor = 'var(--text-light)';
                countdownValue.style.color = 'var(--text-light)';
            } else {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const interviewDate = new Date(userProfile.interviewDate);
                interviewDate.setHours(0, 0, 0, 0);
                const diffTime = interviewDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                countdownLabel.textContent = 'Interview In';
                countdownValue.textContent = diffDays;
                countdownUnit.textContent = diffDays === 1 ? 'day' : 'days';

                // Color coding based on urgency
                if (diffDays <= 7) {
                    countdownBox.style.borderColor = '#ef4444'; // red
                    countdownValue.style.color = '#ef4444';
                } else if (diffDays <= 30) {
                    countdownBox.style.borderColor = '#f59e0b'; // orange
                    countdownValue.style.color = '#f59e0b';
                } else {
                    countdownBox.style.borderColor = 'var(--accent)';
                    countdownValue.style.color = 'var(--accent)';
                }
            }
        }

        // Save profile to localStorage
        function saveProfileToStorage() {
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
        }

        // Modal functions
        function openProfileModal() {
            document.getElementById('profile-modal').classList.add('active');
            loadProfileToForm();
            initCompanyInput();
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        window.openProfileModal = openProfileModal;
        window.closeProfileModal = closeProfileModal;

        // Load current profile into form
        function loadProfileToForm() {
            // Set experience level
            const expRadio = document.querySelector(`input[name="experience"][value="${userProfile.experience}"]`);
            if (expRadio) expRadio.checked = true;

            // Set companies
            selectedCompanies = [...userProfile.companies];
            renderCompanyTags();

            // Set weak areas
            userProfile.weakAreas.forEach(area => {
                const checkbox = document.getElementById(`area-${area}`);
                if (checkbox) checkbox.checked = true;
            });

            // Set interview mode
            if (userProfile.interviewMode === 'scheduled') {
                setDateMode('scheduled');
                if (userProfile.interviewDate) {
                    document.getElementById('interview-date').value = userProfile.interviewDate;
                }
            } else {
                setDateMode('practice');
            }
        }

        // Company selection
        function initCompanyInput() {
            const input = document.getElementById('company-input');
            const options = document.getElementById('company-options');

            input.addEventListener('focus', () => {
                showCompanyOptions('');
            });

            input.addEventListener('input', (e) => {
                showCompanyOptions(e.target.value);
            });

            // Click outside to close
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.company-dropdown')) {
                    options.classList.remove('active');
                }
            });

            // Enter to add custom company
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = input.value.trim();
                    if (value && !selectedCompanies.includes(value)) {
                        selectedCompanies.push(value);
                        renderCompanyTags();
                        input.value = '';
                        options.classList.remove('active');
                    }
                }
            });
        }

        function showCompanyOptions(filter) {
            const options = document.getElementById('company-options');
            const filtered = COMPANIES.filter(c =>
                c.toLowerCase().includes(filter.toLowerCase()) &&
                !selectedCompanies.includes(c)
            );

            if (filtered.length === 0) {
                options.innerHTML = '<div class="company-option" style="color: var(--text-light);">Press Enter to add custom company</div>';
            } else {
                options.innerHTML = filtered.map(company =>
                    `<div class="company-option" onclick="addCompany('${company}')">${company}</div>`
                ).join('');
            }

            options.classList.add('active');
        }

        function addCompany(company) {
            if (!selectedCompanies.includes(company)) {
                selectedCompanies.push(company);
                renderCompanyTags();
                document.getElementById('company-input').value = '';
                document.getElementById('company-options').classList.remove('active');
            }
        }

        window.addCompany = addCompany;

        function removeCompany(company) {
            selectedCompanies = selectedCompanies.filter(c => c !== company);
            renderCompanyTags();
        }

        window.removeCompany = removeCompany;

        function renderCompanyTags() {
            const container = document.getElementById('company-tags');
            if (selectedCompanies.length === 0) {
                container.innerHTML = '<span style="color: var(--text-light); padding: 0.5rem;">No companies selected</span>';
            } else {
                container.innerHTML = selectedCompanies.map(company =>
                    `<span class="company-tag">${company}<button onclick="removeCompany('${company}')">√ó</button></span>`
                ).join('');
            }
        }

        // Date mode toggle
        function setDateMode(mode) {
            const buttons = document.querySelectorAll('.date-mode-btn');
            const wrapper = document.getElementById('date-input-wrapper');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (mode === 'practice') {
                buttons[0].classList.add('active');
                wrapper.classList.remove('active');
            } else {
                buttons[1].classList.add('active');
                wrapper.classList.add('active');
            }
        }

        window.setDateMode = setDateMode;

        // Save profile
        function saveProfile() {
            // Get experience
            const experienceRadio = document.querySelector('input[name="experience"]:checked');
            userProfile.experience = experienceRadio ? experienceRadio.value : 'junior';

            // Get companies
            userProfile.companies = [...selectedCompanies];

            // Get weak areas
            const weakAreas = [];
            document.querySelectorAll('.checkbox-option input[type="checkbox"]:checked').forEach(cb => {
                weakAreas.push(cb.value);
            });
            userProfile.weakAreas = weakAreas;

            // Get interview mode
            const isPracticeMode = document.querySelectorAll('.date-mode-btn')[0].classList.contains('active');
            userProfile.interviewMode = isPracticeMode ? 'practice' : 'scheduled';

            // Get interview date
            if (userProfile.interviewMode === 'scheduled') {
                userProfile.interviewDate = document.getElementById('interview-date').value;
            } else {
                userProfile.interviewDate = null;
            }

            // Save to localStorage
            saveProfileToStorage();

            // Update display
            updateProfileDisplay();

            // Close modal
            closeProfileModal();

            // Show success feedback (optional)
            console.log('Profile saved:', userProfile);
        }

        window.saveProfile = saveProfile;

        // Load profile on page load
        loadProfile();
    </script>
</body>
</html>
